\chapter{Технологическая часть}
В данной части рассматривается выбор средств реализации, описывается реализация алгоритмов и приводится интерфейс программного
обеспечения.




\section{Средства Реализации}
Для реализации описанных алгоритмов был язык \texttt{C++}, в силу следующих причин:
\begin{enumerate}
	\item в стандартной библиотеке языка присутствует поддержка всех структур данных,
	выбранных на этапе проектирования~\cite{STL};
	\item существуют фреймворк для выбранного языка, позволяющий реализовать графический интерфейс~\cite{qt_c++};
	\item язык позволяет использовать библиотеку для упрощения использования графического процессора~\cite{qt_opengl}.
\end{enumerate}


Ввиду высокой трудоемкости построения изображения, для ускорения получения кадра и
парализации вычислений, был выбран OPENGL, поддерживаемый QT, позволяющий реализовать описанные алгоритмы на языке GLSL для реализации вычислений на графическом процессоре~\cite{ray_trace_glsl}.

В качестве среды разработки была выбрана среда разработки  CLion, так как она~\cite{clion}:
\begin{enumerate}
    \item позволяет использовать утилиту CMake, что позволит конфигурировать проект независимо от платформы;
    \item поддерживает выделение glsl кода;
    \item обладает необходимым функционалом для сборки, профилирования и отладки программ.
\end{enumerate}


\section{Реализация алгоритмов}
В листинге \ref{lst:inter.frag} приведен код расчета пересечений с рассматриваемыми примитивами на языке glsl, данные функции принимают
параметры луча и примитива  и рассчитывают параметр $t$ точки пересечения луча, а также нормаль   в точке пересечения.
Аргументы функций, имеющие префикс~--- \texttt{out} также являются результатом работы функции.
В переменную \texttt{normal} сохраняется значение нормали в точке пересечения, в переменную \texttt{fraction} сохраняется 
значение параметра $t$ точки пересечения. Функция возвращает \texttt{true} в случае если пересечение с примитивом было обнаружено и \texttt{false}
иначе. 
В листинге \ref{lst:phong.frag} приведена реализация  расчета интенсивности света 
луча с использованием модели Фонга. Входными данными для данной функции являются параметры пересечения (нормаль, точка пересечения, трассируемый луч, 
материал пересеченного объекта), выходными данными являются параметры отраженного луча  и интенсивность света в данной точке пересечения.

В листинге \ref{lst:find_inter.frag} приведена реализация  поиска ближайшего пересечения луча со всеми  примитивами сцены.

В листинге \ref{lst:trace.frag}  приведена реализация алгоритма трассировки лучей. 
Стоит отметить умножение интенсивности результирующего луча на 
коэффициент зеркального отражения
при каждом отражении, это необходимо для убывания интенсивности света при  столкновении луча  с примитивом,
так как часть энергии света будет поглощена. Также в данной реализации строиться луч к источнику света для
визуализации теней. Источник света представляет собой сферу. Для предотвращения отражений от источника, в случае попадания в него первичных~(не отраженных)
лучей цикл трассировки данного луча прекращается.






\section{Интерфейс программного обеспечения}

На картинке \ref{img:interface_1} представлен интерфейс ПО.
\includeimage
{interface_1} % Имя файла без расширения (файл должен быть расположен в директории inc/img/)
{f} % Обтекание (без обтекания)
{H} % Положение рисунка (см. figure из пакета float)
{1\textwidth} % Ширина рисунка
{Интерфейс разработанной программы} % Подпись рисунка

При запуске программы отображается источник освещения, пользователь удален на 2 от центра координат по оси z, источник света находится в центре координат. 

При нажатии на правую кнопку мыши с помощью перемещения мыши пользователь может поворачивать камеру.

Снизу экрана отображается панель управления. 
На картинке \ref{img:interface_1} представлен интерфейс ПО.
\includeimage
{interface_board} % Имя файла без расширения (файл должен быть расположен в директории inc/img/)
{f} % Обтекание (без обтекания)
{H} % Положение рисунка (см. figure из пакета float)
{1\textwidth} % Ширина рисунка
{Панель управления программы} % Подпись рисунка

В графе параметры света описывается текущее положение источника света
и интенсивность каждого канала света, в случае изменения значений каждого из данных полей, будут соответственно изменены параметры источника света.

\includeimage
{interface_addition} % Имя файла без расширения (файл должен быть расположен в директории inc/img/)
{f} % Обтекание (без обтекания)
{H} % Положение рисунка (см. figure из пакета float)
{1\textwidth} % Ширина рисунка
{Добавление примитививов} % Подпись рисунка

Поле <<добавление примитива>>, позволяет добавить один из описанных примитивов, все примитивы при добавлении имеют координаты центра в начале координат и один и тот же материал.
При смене примитива в поле <<выбор примитива>>, его текущие характеристики отобразятся в полях <<перемещение примитива>>  и <<материал примитива>>.

Поле <<материал примитива>> описывает, цвет примитива в RGB формате,
а также описывает спектральные характеристики (коэффициенты рассеянного, диффузного и зеркального отражения соответственно).
В случае изменения данных параметров изменяется материал выбранного примитива на изображении.

В случае нажатия  на кнопки <<повернуть>>, <<переместить>>,
центр фигуры переместится в введенные в поле <<перемещения примитива координаты>>. При нажатии на кнопку <<повернуть>>, выбранный примитив
поворачивается на введенные в поля <<поворот примитива>> градусы вокруг своего центра масс, конус вращается вокруг своей вершины, куб будет повернут относительно его начального состояния (нормали плоскостей куба параллельны осям координат).

\section{Тестирование}
В данной части работы будут рассмотрены тесты реалистичности получаемых изображений, а также функциональные тесты.

\subsection{Реалистичность отображаемых примитивов}
Ожидание: отображение примитивов  в соответствии с их геометрическими определениями.
Результат приведен на рисунке \ref{img:primitives}:
\includeimage
{primitives} % Имя файла без расширения (файл должен быть расположен в директории inc/img/)
{f} % Обтекание (без обтекания)
{H} % Положение рисунка (см. figure из пакета float)
{1\textwidth} % Ширина рисунка
{Результат визуализации рассматриваемых примитивов} % Подпись рисунка
Тест был успешно пройден.

\subsection{Смена блика}
Ожидание: цвет бликов должен соответствовать цвету освещения.
Результат приведен на рисунке \ref{img:primitive_reflexion_test}:
\includeimage
{primitive_reflexion_test} % Имя файла без расширения (файл должен быть расположен в директории inc/img/)
{f} % Обтекание (без обтекания)
{H} % Положение рисунка (см. figure из пакета float)
{1\textwidth} % Ширина рисунка
{Результат визуализации с измененным цветом источника} % Подпись рисунка
Тест был успешно пройден.

\subsection{<<Рекурсивное>> отражение примитивов}
Ожидание: один примитив должен отражаться во втором, затем второй в первом и~т.д. Ввиду поглощения света последующие отражения примитивов должны иметь меньшую интенсивность. Результаты тестирования приведены на рисунке \ref{img:corridor_test}, тестирование было проведено при максимальном числе отражений равном пяти.
\includeimage
{corridor_test} % Имя файла без расширения (файл должен быть расположен в директории inc/img/)
{f} % Обтекание (без обтекания)
{H} % Положение рисунка (см. figure из пакета float)
{1\textwidth} % Ширина рисунка
{Результат визуализации отражений} % Подпись рисунка
Тест был успешно пройден.

\subsection{Отражение нескольких примитивов}
Ожидание: на сцене присутствуют 3 примитива, на одном из примитивов  присутствуют отражения от иных примитивов. Результаты представлены на рисунке~\ref{img:multiple_reflexion_test}.
\includeimage
{multiple_reflexion_test} % Имя файла без расширения (файл должен быть расположен в директории inc/img/)
{f} % Обтекание (без обтекания)
{H} % Положение рисунка (см. figure из пакета float)
{1\textwidth} % Ширина рисунка
{Результат визуализации отражений} % Подпись рисунка
Тест был успешно пройден.


\section*{Вывод}

В данном разделе был описан язык программирования, используемые библиотеки и описан разработанный интерфейс, также приведены листинги реализаций основных функций разработанной программы. Также были описаны тесты и приведены получаемые изображения.









